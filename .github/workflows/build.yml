name: Build Android APK & AAB

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Auto increment versionCode
      run: |
        # جيب الـ versionCode الحالي وزوده +1
        CURRENT_VERSION=$(node -p "require('./app.json').expo.android.versionCode")
        NEW_VERSION=$((CURRENT_VERSION + 1))
        echo "Current version: $CURRENT_VERSION, New version: $NEW_VERSION"
        
        # حدث الـ app.json
        npm install -g json
        json -I -f app.json -e "this.expo.android.versionCode=$NEW_VERSION"
        
    - name: Setup Android Keystore
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/android-keystore.jks
        
    - name: Create signing properties
      run: |
        cat > android/gradle.properties << EOF
        MYAPP_UPLOAD_STORE_FILE=android-keystore.jks
        MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.KEY_ALIAS }}
        MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}
        MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
        ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_FILE=android-keystore.jks
        ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.KEY_ALIAS }}
        ORG_GRADLE_PROJECT_MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}
        ORG_GRADLE_PROJECT_MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
        hermesEnabled=true
        org.gradle.project.hermesEnabled=true
        android.enableJetifier=true
        android.useAndroidX=true
        newArchEnabled=true
        org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=3g
        EOF
        
    - name: Build APK and AAB
      run: |
        cd android
        chmod +x gradlew
        ./gradlew clean assembleRelease bundleRelease \
          -Dorg.gradle.jvmargs="-Xmx6g -XX:MaxMetaspaceSize=3g" \
          -x lint \
          -x test \
          -x lintVitalAnalyzeRelease \
          --no-daemon
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/app/build/outputs/apk/release/app-release.apk
        
    - name: Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-aab
        path: android/app/build/outputs/bundle/release/app-release.aab